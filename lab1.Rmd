---
title: "Laboratório 1 - Validação Cruzada e Seleção de Variáveis"
author: "ME905"
output: pdf_document
---

```{r setup, include=FALSE}
require(glmnet)
require(readr)
```

# Instruções

- Esta atividade contém duas partes com o mesmo peso na avaliação.

- Junto do código em cada item, descreva em forma de texto o método sendo
utilizado e discuta os resultados.
Apresente equações se achar necessário.

- Apresente respostas completas e apresente gráficos se achar necessário.

- A menos quando especificado, evite utilizar funções "prontas" para tarefas
que podem ser feitas utilizando a sintaxe básica do R. Por exemplo, a
separação dos bancos de dados em treino e teste deve ser implementada
sem funções de pacotes.

# Parte 1 - Seleção de Variáveis

O conjunto de dados `l1d1.csv` contém informações de 300 variáveis
(`x001` a `x300`) e uma variável resposta `y` (contínua) para 5000 observações.
O objetivo dessa parte é apresentar um modelo de regressão linear
(perda quadrática) com algum subconjunto das 300 variáveis disponíveis.

  (1) Obtenha um conjunto de variáveis com efeito significativo na resposta
  com base em testes de hipóteses. Faça os ajustes necessários
  (escolha um dos métodos) para controlar o número de
  variáveis selecionadas.

```{r}
# leitura banco de dados
db <- read_csv("l1d1.csv")
db_val <- read_csv("l1d1-val.csv")

model <- lm(y ~., data = db)

ajuste <- summary(model)
ajuste$coefficients[ajuste$coefficients[, 4] < 0.05/300, 4]

model_reajustado <- lm(y ~ ., data = db[c(1, which(ajuste$coefficients[,4] < 0.05/300))])
summary(model_reajustado)
```

  (2) Implemente o método *Forward Stepwise Regression* e obtenha o conjunto
  de variáveis que minimiza o erro de predição sob perda quadrática para
  um conjunto de dados de teste.
  
```{r}
n <- nrow(db)
set.seed(123)
amostra_teste <- sample(1:n, size = n/5, replace = FALSE)
df_treino <- db[-amostra_teste,]
df_teste <- db[amostra_teste,]
resultados <- data.frame(
EQM_treino = numeric(0),
EQM_teste = numeric(0)
)

fsr <- function(data, p_max = 40){
  resposta <- db[,1]
  covariavel <- db[,-1]
  
  p <- 0
  df_atualizado <- resposta
  
  ssr_por_p <- data.frame(p = c(), ssr_min = c())
  
  while (p < p_max){
    ssr <- c()
    for (i in 1:ncol(covariavel)){
      df_atualizado <- cbind(df_atualizado[,1:(p+1)], covariavel[,i])
      
      modelo <- lm(y~.,df_atualizado) 
      ssr <- c(ssr, sum(summary(modelo)$residuals^2))
      
    }
    ssr_por_p <- rbind(ssr_por_p, c(p,min(ssr)))
    
    df_atualizado <- cbind(df_atualizado[,1:(p+1)], covariavel[,which.min(ssr)])
    
    colnames(df_atualizado) <- c("y", colnames(df_atualizado)[2:ncol(df_atualizado)])
    covariavel <- covariavel[,-which.min(ssr)]
    
    p <- p+1
  }
  
  #modelo_final <- lm(y ~., df_atualizado)
  
  return(ssr_por_p)
}

fsr(db)


```
  
  
  (3) Refaça o item 2 utilizando o método de validação cruzada k-fold, com
  k = 5.
  
```{r}
# conjunto de teste e treino
n <- nrow(db)
set.seed(123)
amostra_teste <- sample(1:n, size = n/5, replace = FALSE)
df_treino <- db[-amostra_teste,]
df_teste <- db[amostra_teste,]
resultados <- data.frame(
EQM_treino = numeric(0),
EQM_teste = numeric(0)
)
```
  
  
  (4) Com base nos métodos discutidos e nos resultados obtidos, qual subconjunto
  das 300 variáveis você diria que possuem um efeito não nulo na resposta $y$?
  
# Parte 2 - LASSO

Para essa parte, utilize a função `glmnet` do pacote `glmnet` para realizar
ajustes utilizando o método LASSO.

  (1) Leia a documentação da função `glmnet` e a vignette disponível em
  https://glmnet.stanford.edu/articles/glmnet.html. Descreva os principais
  parâmetros da função que serão necessários para ajustar um modelo baseado
  em LASSO para um determinado conjunto de dados.
  
  (2) Separe 10% do seu conjunto de dados como um conjunto de dados de teste.
  Com os 90% restante (conjunto de treino), ajuste uma regressão com LASSO
  considerando $\lambda = 2$. Calcule o Erro Quadrático Médio de predição
  para o conjunto de treino e o conjunto de teste. Quantas variáveis
  tiveram coeficientes não nulos para este ajuste?
  
  (3) Escolha (pelo menos) 10 valores de $\lambda$.
  Para cada valor de $\lambda$, refaça o item (2), com os mesmos conjuntos
  de treino/teste. Compare os erros de predição no teste para cada valor de
  $\lambda$. Qual valor de $\lambda$ produziu o menor erro de predição?

  (4) Considere os dados no arquivo `l1d1-val.csv`. Este conjunto de dados
  não possui o valor da variável resposta. Gere um arquivo chamada `l1-pred-[grupo].csv`
  contendo as predições para as 1000 observações disponíveis no arquivo, com
  base no ajuste que você considera mais apropriado para fazer predições.
  Substitua `[grupo]` pela letra associada ao grupo no Moodle.
